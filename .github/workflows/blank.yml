name: Download Anime m3u8 (Disk-Safety Version)

on:
  workflow_dispatch:
    inputs:
      json_url:
        description: 'JSON 文件的 URL 地址'
        required: true

jobs:
  download_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install FFmpeg and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq

      - name: Process JSON and Upload Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JSON_URL: ${{ github.event.inputs.json_url }}
        run: |
          # 1. 获取并解析数据
          echo "Fetching JSON..."
          JSON_DATA=$(curl -sL "$JSON_URL")
          ANIME_NAME=$(echo "$JSON_DATA" | jq -r '.animeName')
          mapfile -t URLS < <(echo "$JSON_DATA" | jq -r '.urls[]')
          TOTAL=${#URLS[@]}

          echo "Anime: $ANIME_NAME, Total Episodes: $TOTAL"

          # 2. 循环处理
          for (( i=0; i<$TOTAL; i++ )); do
            EP_NUM=$((i + 1))
            M3U8_URL="${URLS[$i]}"
            RELEASE_TAG="${ANIME_NAME}-${EP_NUM}"
            FILE_NAME="${EP_NUM}.mp4"

            echo "======= Processing Episode $EP_NUM / $TOTAL ======="
            
            # 检查 Release 是否已存在
            if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
              echo ">>> Skip: $RELEASE_TAG already exists."
              continue
            fi

            # 打印当前剩余空间（调试用）
            echo "Current Disk Usage:"
            df -h / | grep /

            # 下载逻辑：使用 ffmpeg
            # 增加重试机制和网络优化参数
            echo ">>> Downloading $M3U8_URL..."
            ffmpeg -i "$M3U8_URL" \
                   -c copy \
                   -bsf:a aac_adtstoasc \
                   -y "$FILE_NAME" # -y 表示如果文件存在则覆盖

            # 检查下载是否成功且文件大小大于 0
            if [ $? -eq 0 ] && [ -s "$FILE_NAME" ]; then
              echo ">>> Download Success. Size: $(du -h "$FILE_NAME" | cut -f1)"
              
              # 创建 Release 并上传
              echo ">>> Uploading to Release $RELEASE_TAG..."
              if gh release create "$RELEASE_TAG" "$FILE_NAME" --title "$RELEASE_TAG" --notes "Automated upload"; then
                echo ">>> Upload Success!"
              else
                echo ">>> Upload Failed! Cleaning up..."
              fi
            else
              echo ">>> Download Failed for Episode $EP_NUM"
            fi

            # 【关键】无论成功或失败，立刻删除本地视频文件，释放空间
            if [ -f "$FILE_NAME" ]; then
              rm -f "$FILE_NAME"
              echo ">>> Local file $FILE_NAME deleted to free up space."
            fi

            # 每次循环清理一下系统的临时缓存（可选）
            sync
          done

          echo "All tasks finished."
